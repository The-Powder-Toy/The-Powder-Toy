#include <math.h>
#include "Sound.h"
#include "Config.h"
#define PI 3.14159265358979
float sine[400]={0.00000f,0.01571f,0.03141f,0.04711f,0.06279f,0.07846f,0.09411f,0.10973f,0.12533f,0.14090f,0.15643f,0.17193f,0.18738f,0.20279f,0.21814f,0.23345f,0.24869f,0.26387f,0.27899f,0.29404f,0.30902f,0.32392f,0.33874f,0.35347f,0.36812f,0.38268f,0.39715f,0.41151f,0.42578f,0.43994f,0.45399f,0.46793f,0.48175f,0.49546f,0.50904f,0.52250f,0.53583f,0.54902f,0.56208f,0.57501f,0.58779f,0.60042f,0.61291f,0.62524f,0.63742f,0.64945f,0.66131f,0.67301f,0.68455f,0.69591f,0.70711f,0.71813f,0.72897f,0.73963f,0.75011f,0.76041f,0.77051f,0.78043f,0.79016f,0.79968f,0.80902f,0.81815f,0.82708f,0.83581f,0.84433f,0.85264f,0.86074f,0.86863f,0.87631f,0.88377f,0.89101f,0.89803f,0.90483f,0.91140f,0.91775f,0.92388f,0.92978f,0.93544f,0.94088f,0.94609f,0.95106f,0.95579f,0.96029f,0.96456f,0.96858f,0.97237f,0.97592f,0.97922f,0.98229f,0.98511f,0.98769f,0.99002f,0.99211f,0.99396f,0.99556f,0.99692f,0.99803f,0.99889f,0.99951f,0.99988f,1.00000f,0.99988f,0.99951f,0.99889f,0.99803f,0.99692f,0.99556f,0.99396f,0.99211f,0.99002f,0.98769f,0.98511f,0.98229f,0.97922f,0.97592f,0.97237f,0.96858f,0.96456f,0.96029f,0.95579f,0.95106f,0.94609f,0.94088f,0.93544f,0.92978f,0.92388f,0.91775f,0.91140f,0.90483f,0.89803f,0.89101f,0.88377f,0.87631f,0.86863f,0.86074f,0.85264f,0.84433f,0.83581f,0.82708f,0.81815f,0.80902f,0.79968f,0.79016f,0.78043f,0.77051f,0.76041f,0.75011f,0.73963f,0.72897f,0.71813f,0.70711f,0.69591f,0.68455f,0.67301f,0.66131f,0.64945f,0.63742f,0.62524f,0.61291f,0.60042f,0.58779f,0.57501f,0.56208f,0.54902f,0.53583f,0.52250f,0.50904f,0.49546f,0.48175f,0.46793f,0.45399f,0.43994f,0.42578f,0.41151f,0.39715f,0.38268f,0.36812f,0.35347f,0.33874f,0.32392f,0.30902f,0.29404f,0.27899f,0.26387f,0.24869f,0.23345f,0.21814f,0.20279f,0.18738f,0.17193f,0.15643f,0.14090f,0.12533f,0.10973f,0.09411f,0.07846f,0.06279f,0.04711f,0.03141f,0.01571f,-0.00000f,-0.01571f,-0.03141f,-0.04711f,-0.06279f,-0.07846f,-0.09411f,-0.10973f,-0.12533f,-0.14090f,-0.15643f,-0.17193f,-0.18738f,-0.20279f,-0.21814f,-0.23345f,-0.24869f,-0.26387f,-0.27899f,-0.29404f,-0.30902f,-0.32392f,-0.33874f,-0.35347f,-0.36812f,-0.38268f,-0.39715f,-0.41151f,-0.42578f,-0.43994f,-0.45399f,-0.46793f,-0.48175f,-0.49546f,-0.50904f,-0.52250f,-0.53583f,-0.54902f,-0.56208f,-0.57501f,-0.58779f,-0.60042f,-0.61291f,-0.62524f,-0.63742f,-0.64945f,-0.66131f,-0.67301f,-0.68455f,-0.69591f,-0.70711f,-0.71813f,-0.72897f,-0.73963f,-0.75011f,-0.76041f,-0.77051f,-0.78043f,-0.79016f,-0.79968f,-0.80902f,-0.81815f,-0.82708f,-0.83581f,-0.84433f,-0.85264f,-0.86074f,-0.86863f,-0.87631f,-0.88377f,-0.89101f,-0.89803f,-0.90483f,-0.91140f,-0.91775f,-0.92388f,-0.92978f,-0.93544f,-0.94088f,-0.94609f,-0.95106f,-0.95579f,-0.96029f,-0.96456f,-0.96858f,-0.97237f,-0.97592f,-0.97922f,-0.98229f,-0.98511f,-0.98769f,-0.99002f,-0.99211f,-0.99396f,-0.99556f,-0.99692f,-0.99803f,-0.99889f,-0.99951f,-0.99988f,-1.00000f,-0.99988f,-0.99951f,-0.99889f,-0.99803f,-0.99692f,-0.99556f,-0.99396f,-0.99211f,-0.99002f,-0.98769f,-0.98511f,-0.98229f,-0.97922f,-0.97592f,-0.97237f,-0.96858f,-0.96456f,-0.96029f,-0.95579f,-0.95106f,-0.94609f,-0.94088f,-0.93544f,-0.92978f,-0.92388f,-0.91775f,-0.91140f,-0.90483f,-0.89803f,-0.89101f,-0.88377f,-0.87631f,-0.86863f,-0.86074f,-0.85264f,-0.84433f,-0.83581f,-0.82708f,-0.81815f,-0.80902f,-0.79968f,-0.79016f,-0.78043f,-0.77051f,-0.76041f,-0.75011f,-0.73963f,-0.72897f,-0.71813f,-0.70711f,-0.69591f,-0.68455f,-0.67301f,-0.66131f,-0.64945f,-0.63742f,-0.62524f,-0.61291f,-0.60042f,-0.58779f,-0.57501f,-0.56208f,-0.54902f,-0.53583f,-0.52250f,-0.50904f,-0.49546f,-0.48175f,-0.46793f,-0.45399f,-0.43994f,-0.42578f,-0.41151f,-0.39715f,-0.38268f,-0.36812f,-0.35347f,-0.33874f,-0.32392f,-0.30902f,-0.29404f,-0.27899f,-0.26387f,-0.24869f,-0.23345f,-0.21814f,-0.20279f,-0.18738f,-0.17193f,-0.15643f,-0.14090f,-0.12533f,-0.10973f,-0.09411f,-0.07846f,-0.06279f,-0.04711f,-0.03141f,-0.01571f};
float cheap_sin(float v)
{
	return sine[((int)(v/PI*200.f))%400];
}
float note_freq[MAX_NOTE];
int note_len[MAX_NOTE];
int note_smp[MAX_NOTE];
void add_note(float f, int l)
{
	int i;
	for(i=0;i<MAX_NOTE;i++)
	{
		if(!note_len[i])
		{
			note_freq[i]=f;
			note_len[i]=l;
			note_smp[i]=0;
			break;
		}
	}
}
#define SINE(F,S) (cheap_sin(2.0f*PI*(F)*(S)/44100.0f))
#define DECAY(F,S,L) (SINE(F,S)*(1.0f-(S)/(float)(L)))
void create_tone(void *userdata, Uint8 *stream, int l)
{
	int i,k;
	for(;l;l--)
	{
		float smp=0.0f;
		int a=0;
		for(i=0;i<MAX_NOTE;i++)
		{
			if(note_len[i])
			{
				a++;
				smp+=DECAY(note_freq[i],note_smp[i],note_len[i])*1024.0f;
				smp+=DECAY(note_freq[i]*2.0f,note_smp[i],note_len[i])*512.0f;
				smp+=DECAY(note_freq[i]*3.0f,note_smp[i],note_len[i])*341.3f;
				smp+=DECAY(note_freq[i]*4.0f,note_smp[i],note_len[i])*256.0f;
				smp+=DECAY(note_freq[i]*5.0f,note_smp[i],note_len[i])*204.0f;
				note_smp[i]++;
				if(note_len[i]==note_smp[i])
					note_len[i]=0;
			}
		}
		if(!a){
			for(;l;l--)
				*(stream++)=0;
			return;
		}
#ifdef LIN
		smp=sqrt(smp);
#else
		smp=sqrt(smp/8.0f);
#endif
		if(smp>127.0f)
			*stream=127;
		else if(smp<-128.0f)
			*stream=-128;
		else
			*stream=(signed char)smp;
		stream++;
	}
}
